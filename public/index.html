<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blitzæ”¯æ´åŸºåœ°ç®¡ç†ãƒœãƒ¼ãƒ‰(1-55)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#111827; --muted:#6b7280; --card:#ffffff; --bd:#e5e7eb; --blue:#3b82f6; --blue-dark:#2563eb; --green:#22c55e; --green-dark:#16a34a; --red:#ef4444; --red-dark:#dc2626; --gray:#d1d5db; --gray-dark:#9ca3af; --white:#ffffff; --amber:#f59e0b; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1280px;margin:0 auto;padding:16px}
    h1{font-size:24px;margin:0 0 4px}.muted{color:var(--muted);font-size:12px}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.legend-item{display:flex;align-items:center;gap:6px;font-size:12px}.legend-swatch{width:14px;height:14px;border-radius:4px;border:1px solid rgba(0,0,0,.1)}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:8px;box-shadow:0 1px 2px rgba(0,0,0,.03)}

    .toolbar{display:grid;grid-template-columns: 1fr;grid-auto-rows:auto;row-gap:10px}
    .field{display:flex;flex-direction:column}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px}
    .field input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);outline:none;box-sizing:border-box}
    .field input[type=text]:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#f3f4f6;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue-dark)}
    .btn-amber{background:#fef3c7;color:#7c2d12;border-color:#fcd34d}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(0,0,0,.05)}
    .pill-4{background:var(--blue);color:#fff}.pill-3{background:var(--green);color:#fff}.pill-2{background:var(--red);color:#fff}.pill-1{background:var(--gray);color:#111}.pill-0{background:#fff;color:#111;border-color:#d1d5db}
    .reply{display:inline-block;background:#fffbeb;color:#854d0e;border:1px solid #fde68a;padding:4px 8px;border-radius:8px;font-size:12px}

    .cell{
      width:34px;
      height:34px;
      border:0.5px solid #ddd;
      box-sizing:border-box;
      border-radius:0;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0;
      box-shadow:none;
      user-select:none;
    }

    .cell .num{font-weight:700;line-height:1}
    .cell .sub{font-size:10px;margin-top:2px;text-align:center}
    .cell-inner{text-align:center}

    .bg-4{background:var(--blue);color:#fff;border-color:var(--blue-dark)}
    .bg-3{background:var(--green);color:#fff;border-color:var(--green-dark)}
    .bg-2{background:var(--red);color:#fff;border-color:var(--red-dark)}
    .bg-1{background:var(--gray);color:#111;border-color:var(--gray-dark)}
    .bg-0{background:var(--white);color:#111;border-color:#d1d5db}

    .logs{max-height:320px;overflow:auto;padding-right:6px}
    .log-item{padding:8px 0;border-bottom:1px solid #f3f4f6}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid;margin-right:6px;margin-bottom:4px}
    .badge-ok{background:#ecfdf5;color:#047857;border-color:#a7f3d0}
    .badge-ng{background:#fff1f2;color:#be123c;border-color:#fecdd3}

    .user-list{max-height:360px;overflow:auto;padding-right:6px}
    .user-item{border-bottom:1px dashed #e5e7eb;padding:8px 0}
    .user-name{font-weight:600}
    .nums{margin-top:6px;font-size:13px;line-height:1.6}
    .nums .n{display:inline-block;min-width:22px;text-align:center;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;margin:2px 4px 2px 0}

    .maint-bar{display:none;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;padding:8px 12px;border-radius:12px;background:#fffbeb;border:1px solid #fde68a;color:#7c2d12}
    .maint-on .maint-bar{display:flex}
    .maint-on .cell{outline:2px dashed #f59e0b; outline-offset:2px; cursor:pointer}
    .maint-off .cell{cursor:default}
    
.nums .n.n-rest {
  background: #e5e7eb;
  color: #374151;
  border-color: #d1d5db;
}

  </style>
</head>

<body>
  <div class="container">
    <header style="display:flex;gap:16px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px;">
      <div>
        <h1>Blitzæ”¯æ´åŸºåœ°ç®¡ç†ãƒœãƒ¼ãƒ‰(1-55)</h1>
        <div class="muted">ç©ºã4=é’ / ç©ºã3=ç·‘ / ç©ºã2=èµ¤ / ç©ºã1=ç° / ç©ºã0=ç™½ï¼ˆåŒä¸€æŠ•ç¨¿è€…ã«ã‚ˆã‚‹åŒç•ªå·ã®è¤‡æ•°å–å¾—ã¯ä¸å¯ï¼‰</div>
      </div>
      <div class="legend">
        <div class="legend-item"><span class="legend-swatch" style="background:var(--blue);"></span><span>ç©ºã4</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--green);"></span><span>ç©ºã3</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--red);"></span><span>ç©ºã2</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--gray);"></span><span>ç©ºã1</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--white);border:1px solid #d1d5db;"></span><span>ç©ºã0</span></div>
      </div>
    </header>

<div id="statusArea" class="card" style="margin-bottom:12px;padding:10px;display:flex;align-items:center;gap:12px;">
  <div><strong>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š</strong> <span id="statusText">--</span></div>
  <div style="margin-left:auto;display:flex;gap:8px;">
    <button class="btn" onclick="setStatus('æº–å‚™ä¸­')">æº–å‚™ä¸­</button>
    <button class="btn" onclick="setStatus('ãŠä¼‘ã¿å…¥åŠ›ä¸­')">ãŠä¼‘ã¿å…¥åŠ›ä¸­</button>
    <button class="btn" onclick="setStatus('æŠ•ç¨¿å¾…ã¡')">æŠ•ç¨¿å¾…ã¡</button>
  </div>
</div>

    <section class="card" style="margin-bottom:12px;">
      <div class="toolbar">
        <div class="field">
          <label>æŠ•ç¨¿è€…(ä»»æ„)</label>
          <input id="inUser" type="text" placeholder="ä¾‹: ä½è—¤" />
        </div>
        <div class="field">
          <label>åŸºåœ°ç•ªå·ï¼ˆ<strong>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ã¿</strong>ï¼‰ï½œç©ºãè¿½åŠ : <strong>ã‚¹ãƒšãƒ¼ã‚¹ç„¡ã—ã®ã€Œ-ã€ã§é–‹å§‹</strong></label>
          <input id="inNums" type="text" placeholder="ä¾‹: 5,12,27 ï¼ ç©ºãè¿½åŠ ä¾‹: -5,5,12" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btnPost">æŠ•ç¨¿</button>
          <button class="btn" id="btnReset">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="btn btn-amber" id="btnMaint">ãŠä¼‘ã¿ç®¡ç†</button>
          <div class="muted" id="lastUpdate">æœ€çµ‚æ›´æ–°: --:--:--</div>
          <div class="muted" id="nowTime">ç¾åœ¨æ™‚åˆ»: --:--:--</div>
          <div id="reply" style="margin-left:auto;"></div>
        </div>
        <div id="maintBar" class="maint-bar">
        <div id="maintButtons" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
          <div>ğŸ›  <strong>ãŠä¼‘ã¿ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ä¸­</strong>ï¼šç•ªå·ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ <strong>ç©ºã+1ï¼ˆæœ€å¤§4ï¼‰</strong>ã€‚</div>
          <div><span class="muted">å®Œäº†ã—ãŸã‚‰ OFF ã«æˆ»ã—ã¦ãã ã•ã„ã€‚</span></div>
        </div>
      </div>
    </section>
    <section class="row" style="gap:12px;">
      <div class="card" style="min-height:260px;">
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
          <span class="pill pill-4" id="stat4">ç©ºã4: 55ä»¶</span>
          <span class="pill pill-3" id="stat3">ç©ºã3: 0ä»¶</span>
          <span class="pill pill-2" id="stat2">ç©ºã2: 0ä»¶</span>
          <span class="pill pill-1" id="stat1">ç©ºã1: 0ä»¶</span>
          <span class="pill pill-0" id="stat0">ç©ºã0: 0ä»¶</span>
        </div>
        <div id="board"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px;">æŠ•ç¨¿è€…åˆ¥ å–å¾—ãƒªã‚¹ãƒˆ</h2>
        <div class="muted" style="margin-bottom:6px;">ï¼ˆç¢ºä¿æ¸ˆã¿ã®ç•ªå·ã‚’æŠ•ç¨¿è€…ã”ã¨ã«é›†è¨ˆè¡¨ç¤ºï¼‰</div>
        <div id="userAlloc" class="user-list"></div>
      </div>
    </section>

    <section class="row" style="margin-top:12px;gap:12px;">
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px;">æŠ•ç¨¿ãƒ­ã‚°</h2>
        <div class="logs" id="logs">
          <div class="muted">æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px;">ä½¿ã„æ–¹ãƒ¡ãƒ¢</h2>
        <ul style="margin:0 0 6px 0px;font-size:14px;color:#374151;">
          <li>åŸºåœ°å–å¾—ï¼š<strong>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ã¿</strong>ï¼ˆç©ºç™½ä¸å¯ï¼‰ã€‚ä¾‹ï¼š<code>5,12,27</code></li>
          <li>ç©ºãè¿½åŠ ï¼š<strong>å…ˆé ­ã‚’ã‚¹ãƒšãƒ¼ã‚¹ç„¡ã—ã®ã€Œ-ã€ã§é–‹å§‹</strong>ã—ã€å¾Œã¯ <strong>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ã¿</strong>ã€‚ä¾‹ï¼š<code>-5,5,12</code> â†’ 5ã‚’+2ã€12ã‚’+1ï¼ˆæœ€å¤§4ï¼‰ã€‚</li>
          <li><strong>ã€Œ- 5,12ã€ãªã©ã€ãƒã‚¤ãƒŠã‚¹ã®ç›´å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚‹æŠ•ç¨¿ã¯ã‚¨ãƒ©ãƒ¼</strong>ã¨ã—ã¦æ‹’å¦ã—ã¾ã™ã€‚</li>
          <li>ãŠä¼‘ã¿ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ï¼šONã®é–“ã€ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç©ºã+1ï¼ˆæœ€å¤§4ï¼‰ã€‚</li>
          <li>å…¨ãƒªã‚»ãƒƒãƒˆï¼šå…¨ç•ªå·ã‚’ç©ºã0ã«ã€‚</li>
        </ul>
      </div>
    </section>
  </div>
  <script>
  (function(){
    const BOARD_SIZE=55, MAX_SLOTS=4, TILE=34;

const MAINT_GROUPS = {
  "Ford": [1,2,3,4,5,6,7,20,21,22,23,24,27,28,38,39,40,41,42,45,46],
  "saku": [13,14,15,16,17,18,19,31,32,33,34,35,36,37,49,50,51,52,53,54,55],
  "Astro": [13,14,15,16,17,18,30,33,34,35,36,37,48,51,52,53,54,55],
  "sus": [8,9,10,11,12,25,26,27,28,29,43,44,45,46,47],
  "sam": [8,9,10,11,12,19,30,33,34,35,36,37,48,51,52,53,54,55],
  "ysnr": [13,15,17,19,29,30,31,32,47,48,49,50],
  "niya": [13,14,15,16,17,18,29,30,31,32,36,37,47,48,49,50,51,52],
  "lune": [8,9,10,11,12,20,21,22,25,26,40,41,42,43,44],
  "snow": [4,10,11,12,28,29,31,32,46,47,49,50],
  "å¤§å¸": [5,18,19,33,34,35,53,54,55],
  "ã¾ãƒ¼": [1,2,3,25,26,27,43,44,45],
  "keito": [4,5,23,24,38,39],
  "gato": [6,7,23,24,38,39],
  "ç¥é¾": [6,7,20,21,22,40,41,42],
  "hina": [1,2,3]
};

let state = {
  remaining: [],
  owners: {},
  logs: [],
  lastUpdate: 0,
  status: "æŠ•ç¨¿å¾…ã¡"   // â˜… ã“ã‚Œã‚’è¿½åŠ 
};

    const elBoard=document.getElementById('board');
    const elLogs=document.getElementById('logs');
    const elReply=document.getElementById('reply');
    const elLast=document.getElementById('lastUpdate');
    const inUser=document.getElementById('inUser');
    const inNums=document.getElementById('inNums');
    const btnPost=document.getElementById('btnPost');
    const btnReset=document.getElementById('btnReset');
    const btnMaint=document.getElementById('btnMaint');
    const elMaintBar=document.getElementById('maintBar');
    const elUserAlloc=document.getElementById('userAlloc');

const elStat = {
  0: document.getElementById('stat0'),
  1: document.getElementById('stat1'),
  2: document.getElementById('stat2'),
  3: document.getElementById('stat3'),
  4: document.getElementById('stat4')
};

    const LAYOUT=[
      [0,42,0.5,0,0,0.5,0,0,0.5,0,55],
      [40,41,0.5,45,46,0.5,49,50,0.5,53,54],
      [38,39,0.5,43,44,0.5,47,48,0.5,51,52],
      [0,0,0.5,0,0,0.5,0,0,0.5,0,0],
      [23,24,0.5,27,28,0.5,31,32,0.5,36,37],
      [21,22,0.5,25,26,0.5,29,30,0.5,34,35],
      [0,20,0.5,0,0,0.5,0,0,0.5,0,33],
      [0,0,0.5,0,0,0.5,0,0,0.5,0,0],
      [0,7,0.5,0,0,0.5,19,0,0.5,0,0],
      [5,6,0.5,12,0,0.5,17,18,0.5,0,0],
      [3,4,0.5,10,11,0.5,15,16,0.5,0,0],
      [1,2,0.5,8,9,0.5,13,14,0.5,0,0],
    ];

    const colWidths = LAYOUT[0].map(v => v === 0.5 ? TILE * 0.5 : TILE);

    elBoard.innerHTML='';
    elBoard.style.display='grid';
    elBoard.style.gridTemplateColumns = colWidths.map(w => w + 'px').join(' ');
    elBoard.style.columnGap='0px';
    elBoard.style.rowGap='0px';
    elBoard.style.justifyContent='start';

    const cells=[];
    for(const row of LAYOUT){
      for(const n of row){
        const d=document.createElement('div');
        if(n === 0.5){
          d.style.width = (TILE * 0.5) + 'px';
          d.style.height = TILE + 'px';
          d.style.visibility = 'hidden';
          d.style.border = 'none';
          elBoard.appendChild(d);
          continue;
        }
        if(n === 0){
          d.style.width = TILE + 'px';
          d.style.height = TILE + 'px';
          d.style.visibility = 'hidden';
          d.style.border = 'none';
          elBoard.appendChild(d);
          continue;
        }
        d.className='cell bg-4';
        d.style.width = TILE + 'px';
        d.style.height = TILE + 'px';
        d.title=n+'ç•ª';
        const inner=document.createElement('div');
        inner.className='cell-inner';
        const num=document.createElement('div');
        num.className='num';
        num.textContent=String(n);
        const sub=document.createElement('div');
        sub.className='sub';
        sub.textContent='ç©ºã4';
        inner.appendChild(num);
        inner.appendChild(sub);
        d.appendChild(inner);
        elBoard.appendChild(d);
        cells[n]={root:d,sub};
      }
    }

    function colorClassByRemaining(rem){
      switch(rem){
        case 4:return'bg-4';
        case 3:return'bg-3';
        case 2:return'bg-2';
        case 1:return'bg-1';
        default:return'bg-0';
      }
    }

    function renderBoard(){
      for(let n=1;n<=BOARD_SIZE;n++){
        const c=cells[n];
        if(!c) continue;
        const rem = state.remaining[n];
        c.root.className = 'cell ' + colorClassByRemaining(rem);
        c.sub.textContent = rem === 0 ? 'ç©ºã0' : 'ç©ºã' + rem;
        c.root.title = `${n}ç•ª: ${c.sub.textContent}`;
      }
    }

    function renderStats(){
      const cnt={0:0,1:0,2:0,3:0,4:0};
      for(let i=1;i<=BOARD_SIZE;i++){
        cnt[state.remaining[i]]++;
      }
      elStat[0].textContent='ç©ºã0: '+cnt[0]+'ä»¶';
      elStat[1].textContent='ç©ºã1: '+cnt[1]+'ä»¶';
      elStat[2].textContent='ç©ºã2: '+cnt[2]+'ä»¶';
      elStat[3].textContent='ç©ºã3: '+cnt[3]+'ä»¶';
      elStat[4].textContent='ç©ºã4: '+cnt[4]+'ä»¶';
    }

    function formatTime(ts){
      const d=new Date(ts);
      const pad=n=>String(n).padStart(2,'0');
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function renderLogs(){
      const logs = state.logs || [];
      elLogs.innerHTML = '';
      if(logs.length === 0){
        const d=document.createElement('div');
        d.className='muted';
        d.textContent='æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
        elLogs.appendChild(d);
        return;
      }
      for(const l of logs){
        const item=document.createElement('div');
        item.className='log-item';
        const head=document.createElement('div');
        head.className='muted';
        head.textContent = `${formatTime(l.at)} ãƒ» ${l.user || 'åŒ¿å'}`;
        const body=document.createElement('div');
        for(const r of (l.results || [])){
          const b=document.createElement('span');
          b.className='badge ' + (r.ok ? 'badge-ok' : 'badge-ng');
          if(r.type === 'inc'){
            b.textContent = r.ok ? `${r.number} ç©ºãã‚’+1` : `${r.number} æ—¢ã«ç©ºã4`;
          } else if(r.type === 'err'){
            b.textContent = `ã‚¨ãƒ©ãƒ¼: ${r.msg}`;
          } else if(r.type === 'reset'){
             b.textContent = "å…¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
          } else {
            b.textContent = r.ok ? `${r.number} å–å¾—` : `${r.number}${r.reason==='dup'?' é‡è¤‡ä¸å¯':' ç•ªãªã—'}`;
          }
          body.appendChild(b);
        }
        item.appendChild(head);
        item.appendChild(body);
        elLogs.appendChild(item);
      }
    }

    function renderMeta(){
      elLast.textContent = 'æœ€çµ‚æ›´æ–°: ' + formatTime(state.lastUpdate);
    }

function renderStatus() {
  document.getElementById("statusText").textContent = state.status || "æŠ•ç¨¿å¾…ã¡";
}

function renderAll(){
  renderBoard();
  renderStats();
  renderLogs();
  renderMeta();
  renderUserAlloc();
  renderStatus();   // â˜… è¿½åŠ 
}

async function setStatus(s) {
  await fetch('/setStatus', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ status: s })
  });

  // æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ã—ã¦åæ˜ 
  const res = await fetch('/state');
  state = await res.json();
  renderAll();
}

    function renderUserAlloc(){
      const map=new Map();
      for(let n=1;n<=BOARD_SIZE;n++){
        const arr = state.owners[n] || [];
        arr.forEach(u=>{
          const k=u||'åŒ¿å';
          if(!map.has(k)) map.set(k,[]);
          map.get(k).push(n);
        });
      }
      const users = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b,'ja'));
      elUserAlloc.innerHTML='';
      if(users.length===0){
        const d=document.createElement('div');
        d.className='muted';
        d.textContent='ç¢ºä¿æ¸ˆã¿ã®ç•ªå·ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
        elUserAlloc.appendChild(d);
        return;
      }
      for(const u of users){
        const wrap=document.createElement('div');
        wrap.className='user-item';
        const name=document.createElement('div');
        name.className='user-name';
        name.textContent = `${u}ï¼ˆ${map.get(u).length}ä»¶ï¼‰`;
        const nums=document.createElement('div');
        nums.className='nums';
for(const n of map.get(u).slice().sort((x,y)=>x-y)){
  const s=document.createElement('span');

  // â˜… ãŠä¼‘ã¿åˆ¤å®šã‚’è¿½åŠ 
  s.className = u.includes('ãŠä¼‘ã¿') ? 'n n-rest' : 'n';

  s.textContent=String(n);
  nums.appendChild(s);
}
        wrap.appendChild(name);
        wrap.appendChild(nums);
        elUserAlloc.appendChild(wrap);
      }
    }

    async function fetchStateFromServer(){
      try{
        const res = await fetch('/state');
        const st = await res.json();
        state = st;
        renderAll();
      }catch(e){
        console.error('stateå–å¾—å¤±æ•—', e);
      }
    }

    fetchStateFromServer();
    setInterval(fetchStateFromServer, 1000);

    function parseInput(raw){
      const s=String(raw||'').trim();
      if(!s) return {mode:'take',numbers:[],err:null};
      if(/^-[\s]/.test(s)) return {mode:'err',numbers:[],err:'ç©ºãè¿½åŠ ã¯ã€Œ-ã€ã®ç›´å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œãªã„ã§ãã ã•ã„ï¼ˆä¾‹: -5,12ï¼‰'};
      if(s.startsWith('-')){
        const payload=s.slice(1);
        if(payload.includes(' ')) return {mode:'err',numbers:[],err:'ç©ºãè¿½åŠ ã¯ã‚«ãƒ³ãƒã®ã¿ã§åŒºåˆ‡ã£ã¦ãã ã•ã„ï¼ˆç©ºç™½ä¸å¯ï¼‰'};
        const parts=payload.split(',').map(x=>x.trim()).filter(Boolean);
        const nums=parts.map(Number).filter(n=>Number.isInteger(n)&&n>=1&&n<=BOARD_SIZE);
        return {mode:'inc',numbers:nums,err:null};
      }
      if(/\s/.test(s)) return {mode:'err',numbers:[],err:'åŸºåœ°å–å¾—ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ã¿ä½¿ç”¨ã§ãã¾ã™ï¼ˆç©ºç™½ä¸å¯ï¼‰'};
      const parts=s.split(',').map(x=>x.trim()).filter(Boolean);
      const unique=[...new Set(parts.map(Number))].filter(n=>Number.isInteger(n)&&n>=1&&n<=BOARD_SIZE);
      return {mode:'take',numbers:unique,err:null};
    }

    async function post(){
      const parsed=parseInput(inNums.value);
      if(parsed.mode==='err'){
        elReply.innerHTML='<span class="reply">'+parsed.err+'</span>';
        return;
      }
      if(parsed.numbers.length===0){
        elReply.innerHTML='<span class="reply">æœ‰åŠ¹ãªç•ªå·(1-55)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>';
        return;
      }
      const body = { mode: parsed.mode, numbers: parsed.numbers, user: inUser.value || 'åŒ¿å' };
      const res = await fetch('/post', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      const st = await res.json();
      state = st;
      renderAll();
      inNums.value='';
    }

async function resetAll(){
  if(!confirm('å…¨ç•ªå·ã‚’ç©ºã0ã«ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return;

  // ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œï¼ˆã“ã“ã§ãƒ­ã‚°1è¡ŒãŒä½œã‚‰ã‚Œã‚‹ï¼‰
  await fetch('/reset', {method:'POST'});

  // â˜… reset_log ã‚’é€ã‚‰ãªã„ï¼ˆå‰Šé™¤ï¼‰

  // æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—
  const res = await fetch('/state');
  state = await res.json();

  maintUsed.clear();
  if(maint) setMaint(true);

  renderAll();
  elReply.innerHTML='<span class="reply">å…¨ã¦ç©ºã0ã«è¨­å®šã—ã¾ã—ãŸï¼ˆSYSTEMï¼‰</span>';
}


    /* ------------------------------
       ãŠä¼‘ã¿ç®¡ç†ãƒ¢ãƒ¼ãƒ‰
    ------------------------------ */

    let maint=false;
    let maintUsed = new Set(); // ãŠä¼‘ã¿ç®¡ç†ä¸­ã«æŠ¼ã•ã‚ŒãŸåå‰ã‚’è¨˜éŒ²

    async function maintGroupInc(name){
      // äºŒåº¦æŠ¼ã—é˜²æ­¢
      if(maintUsed.has(name)){
        elReply.innerHTML = `<span class="reply">${name} ã¯ã™ã§ã«å®Ÿè¡Œæ¸ˆã¿ã§ã™</span>`;
        return;
      }

      const nums = MAINT_GROUPS[name];
      if(!nums || nums.length === 0) return;

      const body = {
        mode: 'inc',
        numbers: nums,
        user: name + 'ã•ã‚“ãŠä¼‘ã¿' // â˜… ã“ã“ã§æŒ‡å®šã—ãŸåå‰ãŒå–å¾—ãƒªã‚¹ãƒˆã«è¼‰ã‚Šã¾ã™
      };

      const res = await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(body)
      });

      const st = await res.json();
      state = st;
      renderAll();

      // å®Ÿè¡Œæ¸ˆã¿ã«ç™»éŒ²
      maintUsed.add(name);

      // ãƒœã‚¿ãƒ³ã‚’å³åº§ã«ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
      const btn = document.querySelector(`#maintButtons button[data-name="${name}"]`);
      if(btn){
        btn.disabled = true;
        btn.style.opacity = "0.5";
      }

      elReply.innerHTML = `<span class="reply">${name} ã®æ‹…å½“ç•ªå·ã‚’ã™ã¹ã¦ +1 ã—ã¾ã—ãŸ</span>`;
    }

    function setMaint(on){
      maint = !!on;
      document.body.classList.toggle('maint-on', maint);
      document.body.classList.toggle('maint-off', !maint);
      elMaintBar.style.display = maint ? 'flex' : 'none';
      btnMaint.textContent = maint ? 'ãŠä¼‘ã¿ç®¡ç†ï¼ˆONï¼‰' : 'ãŠä¼‘ã¿ç®¡ç†';

      const wrap = document.getElementById('maintButtons');
      wrap.innerHTML = '';
      if(maint){
        for(const name of Object.keys(MAINT_GROUPS)){
          const b = document.createElement('button');
          b.className = 'btn';
          b.textContent = name;
          b.setAttribute("data-name", name);
          b.onclick = ()=>maintGroupInc(name);

          if(maintUsed.has(name)){
            b.disabled = true;
            b.style.opacity = "0.5";
          }

          wrap.appendChild(b);
        }
      }
    }

    async function handleCellClick(n){
      if(!maint) return;
      if(n<1 || n>BOARD_SIZE) return;
      const rem = state.remaining[n];
      if(rem === MAX_SLOTS){
        const body = { mode: 'set0', numbers: [n], user: 'SYSTEM' };
        const res = await fetch('/post', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        state = await res.json();
        renderAll();
        elReply.innerHTML='<span class="reply">'+n+' ã‚’ç©ºã0ã«ã—ã¾ã—ãŸ (SYSTEM)</span>';
        return;
      }
      if(rem >= MAX_SLOTS){
        elReply.innerHTML='<span class="reply">'+n+' ã¯æ—¢ã«ç©ºã4ã§ã™</span>';
        return;
      }
      const body = { mode: 'inc', numbers: [n], user: 'SYSTEM' };
      const res = await fetch('/post', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      state = await res.json();
      renderAll();
      elReply.innerHTML='<span class="reply">'+n+' ã®ç©ºãã‚’ +1 ã—ã¾ã—ãŸ (SYSTEM)</span>';
    }

    function updateNowTime(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      const t = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.getElementById('nowTime').textContent = 'ç¾åœ¨æ™‚åˆ»: ' + t;
    }

    setInterval(updateNowTime, 1000);
    updateNowTime();

    function bindCellHandlers(){
      for(let n=1;n<=BOARD_SIZE;n++){
        const c=cells[n];
        if(!c) continue;
        c.root.onclick = ()=>handleCellClick(n);
      }
    }

    btnPost.addEventListener('click', post);
    btnReset.addEventListener('click', resetAll);
    btnMaint.addEventListener('click', ()=>setMaint(!maint));
    inNums.addEventListener('keydown', e=>{ if(e.key==='Enter') post(); });

    bindCellHandlers();
    setMaint(false);

  })();
  </script>
</body>
</html>