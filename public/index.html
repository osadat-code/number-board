<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blitz支援基地管理ボード(1-55)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#111827; --muted:#6b7280; --card:#ffffff; --bd:#e5e7eb; --blue:#3b82f6; --blue-dark:#2563eb; --green:#22c55e; --green-dark:#16a34a; --red:#ef4444; --red-dark:#dc2626; --gray:#d1d5db; --gray-dark:#9ca3af; --white:#ffffff; --amber:#f59e0b; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1280px;margin:0 auto;padding:16px}
    h1{font-size:24px;margin:0 0 4px}.muted{color:var(--muted);font-size:12px}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.legend-item{display:flex;align-items:center;gap:6px;font-size:12px}.legend-swatch{width:14px;height:14px;border-radius:4px;border:1px solid rgba(0,0,0,.1)}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:8px;box-shadow:0 1px 2px rgba(0,0,0,.03)}

    .toolbar{display:grid;grid-template-columns: 1fr;grid-auto-rows:auto;row-gap:10px}
    .field{display:flex;flex-direction:column}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px}
    .field input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);outline:none;box-sizing:border-box}
    .field input[type=text]:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#f3f4f6;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue-dark)}
    .btn-amber{background:#fef3c7;color:#7c2d12;border-color:#fcd34d}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(0,0,0,.05)}
    .pill-4{background:var(--blue);color:#fff}.pill-3{background:var(--green);color:#fff}.pill-2{background:var(--red);color:#fff}.pill-1{background:var(--gray);color:#111}.pill-0{background:#fff;color:#111;border-color:#d1d5db}
    .reply{display:inline-block;background:#fffbeb;color:#854d0e;border:1px solid #fde68a;padding:4px 8px;border-radius:8px;font-size:12px}

    .cell{width:34px;height:34px;border:0.5px solid #ddd;box-sizing:border-box;display:flex;align-items:center;justify-content:center;user-select:none;}
    .cell .num{font-weight:700;line-height:1}
    .cell .sub{font-size:10px;margin-top:2px;text-align:center}
    .cell-inner{text-align:center}

    .bg-4{background:var(--blue);color:#fff;border-color:var(--blue-dark)}
    .bg-3{background:var(--green);color:#fff;border-color:var(--green-dark)}
    .bg-2{background:var(--red);color:#fff;border-color:var(--red-dark)}
    .bg-1{background:var(--gray);color:#111;border-color:var(--gray-dark)}
    .bg-0{background:var(--white);color:#111;border-color:#d1d5db}

    .logs{max-height:320px;overflow:auto;padding-right:6px}
    .log-item{padding:8px 0;border-bottom:1px solid #f3f4f6}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid;margin-right:6px;margin-bottom:4px}
    .badge-ok{background:#ecfdf5;color:#047857;border-color:#a7f3d0}
    .badge-ng{background:#fff1f2;color:#be123c;border-color:#fecdd3}

    .user-list{max-height:360px;overflow:auto;padding-right:6px}
    .user-item{border-bottom:1px dashed #e5e7eb;padding:8px 0}
    .user-name{font-weight:600}
    .nums{margin-top:6px;font-size:13px;line-height:1.6}
    .nums .n{display:inline-block;min-width:22px;text-align:center;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;margin:2px 4px 2px 0}

    .maint-bar{display:none;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;padding:8px 12px;border-radius:12px;background:#fffbeb;border:1px solid #fde68a;color:#7c2d12}
    .maint-on .maint-bar{display:flex}
    .maint-on .cell{outline:2px dashed #f59e0b; outline-offset:2px; cursor:pointer}
    .maint-off .cell{cursor:default}
  </style>
</head>

<body>
  <div class="container">
    <header style="display:flex;gap:16px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px;">
      <div>
        <h1>Blitz支援基地管理ボード(1-55)</h1>
        <div class="muted">空き4=青 / 空き3=緑 / 空き2=赤 / 空き1=灰 / 空き0=白</div>
      </div>
    </header>

    <section class="card" style="margin-bottom:12px;">
      <div class="toolbar">
        <div class="field">
          <label>投稿者(任意)</label>
          <input id="inUser" type="text" placeholder="例: 佐藤" />
        </div>
        <div class="field">
          <label>番号（カンマ区切りのみ）</label>
          <input id="inNums" type="text" placeholder="例: 5,12,27" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btnPost">投稿</button>
          <button class="btn" id="btnReset">全リセット</button>
          <button class="btn btn-amber" id="btnMaint">メンテ</button>
          <div class="muted" id="lastUpdate">最終更新: --:--:--</div>
          <div class="muted" id="nowTime">現在時刻: --:--:--</div>
          <div id="reply" style="margin-left:auto;"></div>
        </div>
        <div id="maintBar" class="maint-bar">
          <div id="maintButtons" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
        </div>
      </div>
    </section>

    <section style="display:grid;grid-template-columns: 1fr 350px;gap:12px;">
      <div class="card">
        <div style="display:flex;gap:6px;margin-bottom:12px;">
          <span class="pill pill-4" id="stat4">空き4</span>
          <span class="pill pill-3" id="stat3">空き3</span>
          <span class="pill pill-2" id="stat2">空き2</span>
          <span class="pill pill-1" id="stat1">空き1</span>
          <span class="pill pill-0" id="stat0">空き0</span>
        </div>
        <div id="board"></div>
      </div>
      <div class="card">
        <h2 style="font-size:16px;margin:0 0 8px;">投稿者別 取得リスト</h2>
        <div id="userAlloc" class="user-list"></div>
      </div>
    </section>

    <section class="card" style="margin-top:12px;">
      <h2 style="font-size:16px;margin:0 0 8px;">投稿ログ</h2>
      <div class="logs" id="logs"></div>
    </section>
  </div>

  <script>
  (function(){
    const BOARD_SIZE=55, MAX_SLOTS=4, TILE=34;
    const MAINT_GROUPS = {
      "Ford": [1,2,3,4,5,6,7,20,21,22,23,24,27,28,38,39,40,41,42,45,46],
      "saku": [13,14,15,16,17,18,19,31,32,33,34,35,36,37,49,50,51,52,53,54,55],
      "Astro": [13,14,15,16,17,18,30,33,34,35,36,37,48,51,52,53,54,55],
      "sus": [8,9,10,11,12,25,26,27,28,29,43,44,45,46,47],
      "sam": [8,9,10,11,12,19,30,33,34,35,36,37,48,51,52,53,54,55],
      "ysnr": [13,15,17,19,29,30,31,32,47,48,49,50],
      "niya": [13,14,15,16,17,18,29,30,31,32,36,37,47,48,49,50,51,52],
      "lune": [8,9,10,11,12,20,21,22,25,26,40,41,42,43,44],
      "snow": [4,10,11,12,28,29,31,32,46,47,49,50],
      "大帝": [5,18,19,33,34,35,53,54,55],
      "まー": [1,2,3,25,26,27,43,44,45],
      "keito": [4,5,23,24,38,39],
      "gato": [6,7,23,24,38,39],
      "神龍": [6,7,20,21,22,40,41,42],
      "hina": [1,2,3]
    };

    let state = { remaining: [], owners: {}, logs: [], lastUpdate: 0 };
    let maint = false;
    let maintUsed = new Set();

    const elBoard=document.getElementById('board'), elLogs=document.getElementById('logs'), elReply=document.getElementById('reply'), elLast=document.getElementById('lastUpdate'), inUser=document.getElementById('inUser'), inNums=document.getElementById('inNums'), btnPost=document.getElementById('btnPost'), btnReset=document.getElementById('btnReset'), btnMaint=document.getElementById('btnMaint'), elMaintBar=document.getElementById('maintBar'), elUserAlloc=document.getElementById('userAlloc');
    const elStat = { 0: document.getElementById('stat0'), 1: document.getElementById('stat1'), 2: document.getElementById('stat2'), 3: document.getElementById('stat3'), 4: document.getElementById('stat4') };

    const LAYOUT=[ [0,42,0.5,0,0,0.5,0,0,0.5,0,55],[40,41,0.5,45,46,0.5,49,50,0.5,53,54],[38,39,0.5,43,44,0.5,47,48,0.5,51,52],[0,0,0.5,0,0,0.5,0,0,0.5,0,0],[23,24,0.5,27,28,0.5,31,32,0.5,36,37],[21,22,0.5,25,26,0.5,29,30,0.5,34,35],[0,20,0.5,0,0,0.5,0,0,0.5,0,33],[0,0,0.5,0,0,0.5,0,0,0.5,0,0],[0,7,0.5,0,0,0.5,19,0,0.5,0,0],[5,6,0.5,12,0,0.5,17,18,0.5,0,0],[3,4,0.5,10,11,0.5,15,16,0.5,0,0],[1,2,0.5,8,9,0.5,13,14,0.5,0,0] ];
    const colWidths = LAYOUT[0].map(v => v === 0.5 ? TILE * 0.5 : TILE);
    elBoard.style.display='grid';
    elBoard.style.gridTemplateColumns = colWidths.map(w => w + 'px').join(' ');

    const cells=[];
    for(const row of LAYOUT){
      for(const n of row){
        const d=document.createElement('div');
        if(n === 0.5 || n === 0){
          d.style.width = (n===0.5?TILE*0.5:TILE)+'px'; d.style.height=TILE+'px'; d.style.visibility='hidden';
          elBoard.appendChild(d); continue;
        }
        d.className='cell bg-4'; d.style.width=TILE+'px'; d.style.height=TILE+'px';
        const inner=document.createElement('div'); inner.className='cell-inner';
        const num=document.createElement('div'); num.className='num'; num.textContent=n;
        const sub=document.createElement('div'); sub.className='sub'; sub.textContent='空き4';
        inner.appendChild(num); inner.appendChild(sub); d.appendChild(inner);
        elBoard.appendChild(d); cells[n]={root:d,sub};
      }
    }

    function renderAll(){
      if(!state.remaining.length) return;
      for(let n=1;n<=BOARD_SIZE;n++){
        if(!cells[n])continue;
        const rem = state.remaining[n];
        cells[n].root.className = 'cell bg-'+rem;
        cells[n].sub.textContent = '空き'+rem;
      }
      const cnt={0:0,1:0,2:0,3:0,4:0};
      for(let i=1;i<=BOARD_SIZE;i++) cnt[state.remaining[i]]++;
      for(let i=0;i<=4;i++) elStat[i].textContent='空き'+i+': '+cnt[i]+'件';

      elLogs.innerHTML = '';
      (state.logs || []).slice().reverse().forEach(l=>{
        const item=document.createElement('div'); item.className='log-item';
        const head=document.createElement('div'); head.className='muted'; head.textContent=`${new Date(l.at).toLocaleTimeString()} ・ ${l.user}`;
        const body=document.createElement('div');
        l.results.forEach(r=>{
          const b=document.createElement('span'); b.className='badge '+(r.ok?'badge-ok':'badge-ng');
          if(r.type==='reset' || r.msg==='全リセットしました'){
            b.textContent = "全リセットしました";
          } else if(r.type==='inc'){
            b.textContent = r.ok ? `${r.number} 空き+1` : `${r.number} 既に空き4`;
          } else {
            b.textContent = r.ok ? `${r.number} 取得` : `${r.number} 不可`;
          }
          body.appendChild(b);
        });
        item.appendChild(head); item.appendChild(body); elLogs.appendChild(item);
      });

      const map=new Map();
      for(let n=1;n<=BOARD_SIZE;n++){
        (state.owners[n]||[]).forEach(u=>{
          if(!map.has(u)) map.set(u,[]); map.get(u).push(n);
        });
      }
      elUserAlloc.innerHTML='';
      Array.from(map.keys()).sort().forEach(u=>{
        const w=document.createElement('div'); w.className='user-item';
        w.innerHTML=`<div class="user-name">${u}（${map.get(u).length}件）</div><div class="nums">${map.get(u).sort((a,b)=>a-b).map(n=>`<span class="n">${n}</span>`).join('')}</div>`;
        elUserAlloc.appendChild(w);
      });
      elLast.textContent = '最終更新: ' + new Date(state.lastUpdate).toLocaleTimeString();
    }

    async function fetchState(){
      const res = await fetch('/state'); state = await res.json(); renderAll();
    }
    fetchState(); setInterval(fetchState, 3000);

    // 全リセット機能：サーバーを叩き、かつフロントで「全リセットしました」ログを送信
    async function resetAll(){
      if(!confirm('全番号を空き0にします。よろしいですか?')) return;
      await fetch('/reset', {method:'POST'});
      
      // ログに強制的に出すためのダミーPOST（サーバー側の /post を利用）
      await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode:'inc', numbers:[], user:'SYSTEM', msg:'全リセットしました' })
      });

      maintUsed.clear(); 
      if(maint) setMaint(true);
      fetchState();
      elReply.innerHTML='<span class="reply">全て空き0に設定しました（SYSTEM）</span>';
    }

    // メンテボタン：名前ボタンを押した際に「XXさんお休み」で取得リストに載るように
    async function maintGroupInc(name){
      if(maintUsed.has(name)) return;
      const res = await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode:'inc', numbers:MAINT_GROUPS[name], user: name+'お休み' })
      });
      state = await res.json(); renderAll();
      maintUsed.add(name);
      const btn = document.querySelector(`button[data-name="${name}"]`);
      if(btn){ btn.disabled=true; btn.style.opacity="0.5"; }
      elReply.innerHTML = `<span class="reply">${name}さんの担当を+1しました</span>`;
    }

    function setMaint(on){
      maint=!!on; document.body.classList.toggle('maint-on',maint);
      elMaintBar.style.display=maint?'flex':'none';
      btnMaint.textContent=maint?'メンテ（ON）':'メンテ';
      const wrap=document.getElementById('maintButtons'); wrap.innerHTML='';
      if(maint){
        Object.keys(MAINT_GROUPS).forEach(name=>{
          const b=document.createElement('button'); b.className='btn'; b.textContent=name;
          b.setAttribute("data-name", name); b.onclick=()=>maintGroupInc(name);
          if(maintUsed.has(name)){ b.disabled=true; b.style.opacity="0.5"; }
          wrap.appendChild(b);
        });
      }
    }

    async function handleCellClick(n){
      if(!maint) return;
      const body = { mode: state.remaining[n]>=MAX_SLOTS?'set0':'inc', numbers:[n], user:'SYSTEM' };
      const res = await fetch('/post', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      state = await res.json(); renderAll();
    }

    btnPost.onclick = async () => {
      if(!inNums.value) return;
      const nums = inNums.value.split(',').map(n=>parseInt(n.trim())).filter(n=>n>0);
      const res = await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode:'take', numbers:nums, user:inUser.value||'匿名' })
      });
      state = await res.json(); renderAll(); inNums.value='';
    };
    btnReset.onclick = resetAll;
    btnMaint.onclick = () => setMaint(!maint);
    
    for(let n=1;n<=BOARD_SIZE;n++) if(cells[n]) cells[n].root.onclick=()=>handleCellClick(n);
    setInterval(()=>{
      const d=new Date(); document.getElementById('nowTime').textContent='現在時刻: '+d.toLocaleTimeString();
    },1000);
  })();
  </script>
</body>
</html>