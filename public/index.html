<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blitzæ”¯æ´åŸºåœ°ç®¡ç†ãƒœãƒ¼ãƒ‰(1-55)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#111827; --muted:#6b7280; --card:#ffffff; --bd:#e5e7eb; --blue:#3b82f6; --blue-dark:#2563eb; --green:#22c55e; --green-dark:#16a34a; --red:#ef4444; --red-dark:#dc2626; --gray:#d1d5db; --gray-dark:#9ca3af; --white:#ffffff; --amber:#f59e0b; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1280px;margin:0 auto;padding:16px}
    h1{font-size:24px;margin:0 0 4px}.muted{color:var(--muted);font-size:12px}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.legend-item{display:flex;align-items:center;gap:6px;font-size:12px}.legend-swatch{width:14px;height:14px;border-radius:4px;border:1px solid rgba(0,0,0,.1)}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:8px;box-shadow:0 1px 2px rgba(0,0,0,.03)}

    .toolbar{display:grid;grid-template-columns: 1fr;grid-auto-rows:auto;row-gap:10px}
    .field{display:flex;flex-direction:column}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px}
    .field input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);outline:none;box-sizing:border-box}
    .field input[type=text]:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#f3f4f6;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue-dark)}
    .btn-amber{background:#fef3c7;color:#7c2d12;border-color:#fcd34d}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(0,0,0,.05)}
    .pill-4{background:var(--blue);color:#fff}.pill-3{background:var(--green);color:#fff}.pill-2{background:var(--red);color:#fff}.pill-1{background:var(--gray);color:#111}.pill-0{background:#fff;color:#111;border-color:#d1d5db}
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒ»åˆ‡æ›¿ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .status-area{margin-bottom:12px;padding:10px;border-radius:12px;background:#f1f5f9;border:1px solid var(--bd);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .status-label{font-weight:bold;font-size:14px}
    .status-val{color:var(--blue-dark);background:#fff;padding:2px 8px;border-radius:6px;border:1px solid var(--bd)}

    .cell{
      width:34px; height:34px; border:0.5px solid #ddd; box-sizing:border-box;
      display:flex; align-items:center; justify-content:center; user-select:none;
    }
    .cell .num{font-weight:700;line-height:1}
    .cell .sub{font-size:10px;margin-top:2px;text-align:center}
    .cell-inner{text-align:center}
    .bg-4{background:var(--blue);color:#fff;border-color:var(--blue-dark)}
    .bg-3{background:var(--green);color:#fff;border-color:var(--green-dark)}
    .bg-2{background:var(--red);color:#fff;border-color:var(--red-dark)}
    .bg-1{background:var(--gray);color:#111;border-color:var(--gray-dark)}
    .bg-0{background:var(--white);color:#111;border-color:#d1d5db}

    .logs{max-height:320px;overflow:auto;padding-right:6px}
    .log-item{padding:8px 0;border-bottom:1px solid #f3f4f6}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid;margin-right:6px;margin-bottom:4px}
    .badge-ok{background:#ecfdf5;color:#047857;border-color:#a7f3d0}
    .badge-ng{background:#fff1f2;color:#be123c;border-color:#fecdd3}

    .user-list{max-height:360px;overflow:auto;padding-right:6px}
    .user-item{border-bottom:1px dashed #e5e7eb;padding:8px 0}
    .user-name{font-weight:600}
    .nums{margin-top:6px;font-size:13px;line-height:1.6}
    .nums .n{display:inline-block;min-width:22px;text-align:center;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;margin:2px 4px 2px 0}
    .nums .n.n-rest { background: #e5e7eb; color: #374151; border-color: #d1d5db; }

    .maint-bar{display:none;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;padding:8px 12px;border-radius:12px;background:#fffbeb;border:1px solid #fde68a;color:#7c2d12}
    .maint-on .maint-bar{display:flex}
    .maint-on .cell{outline:2px dashed #f59e0b; outline-offset:2px; cursor:pointer}
    .maint-off .cell{cursor:default}
  </style>
</head>

<body>
  <div class="container">
    <header style="display:flex;gap:16px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px;">
      <div>
        <h1>Blitzæ”¯æ´åŸºåœ°ç®¡ç†ãƒœãƒ¼ãƒ‰(1-55)</h1>
        <div class="muted">ç©ºã4=é’ / ç©ºã3=ç·‘ / ç©ºã2=èµ¤ / ç©ºã1=ç° / ç©ºã0=ç™½</div>
      </div>
      <div class="legend">
        <div class="legend-item"><span class="legend-swatch" style="background:var(--blue);"></span><span>ç©ºã4</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--green);"></span><span>ç©ºã3</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--red);"></span><span>ç©ºã2</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--gray);"></span><span>ç©ºã1</span></div>
        <div class="legend-item"><span class="legend-swatch" style="background:var(--white);border:1px solid #d1d5db;"></span><span>ç©ºã0</span></div>
      </div>
    </header>

    <div class="status-area">
      <div class="status-label">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š<span id="statusText" class="status-val">--</span></div>
      <div style="display:flex; gap:6px;">
        <button class="btn" onclick="setStatus('ä¼‘æ†©ä¸­')">ä¼‘æ†©ä¸­</button>
        <button class="btn" onclick="setStatus('ãŠä¼‘ã¿ã®äººå…¥åŠ›ä¸­')">ãŠä¼‘ã¿ã®äººå…¥åŠ›ä¸­</button>
        <button class="btn" onclick="setStatus('åŸºåœ°ç²å¾—æŠ•ç¨¿å¾…ã¡')">åŸºåœ°ç²å¾—æŠ•ç¨¿å¾…ã¡</button>
      </div>
    </div>

    <section class="card" style="margin-bottom:12px;">
      <div class="toolbar">
        <div class="field">
          <label>æŠ•ç¨¿è€…(ä»»æ„)</label>
          <input id="inUser" type="text" placeholder="ä¾‹: ä½è—¤" />
        </div>
        <div class="field">
          <label>åŸºåœ°ç•ªå·ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ï½œç©ºãè¿½åŠ ä¾‹: -5,12</label>
          <input id="inNums" type="text" placeholder="ä¾‹: 5,12,27 ï¼ -5,5,12" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btnPost">æŠ•ç¨¿</button>
          <button class="btn" id="btnReset">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="btn btn-amber" id="btnMaint">ãŠä¼‘ã¿ç®¡ç†</button>
          <div class="muted" id="lastUpdate">æœ€çµ‚æ›´æ–°: --:--:--</div>
          <div class="muted" id="nowTime">ç¾åœ¨æ™‚åˆ»: --:--:--</div>
          <div id="reply" style="margin-left:auto;"></div>
        </div>
        <div id="maintBar" class="maint-bar">
          <div id="maintButtons" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
          <div>ğŸ›  ãŠä¼‘ã¿ç®¡ç†ä¸­ï¼šã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç©ºã+1ã€‚</div>
        </div>
      </div>
    </section>

    <section class="row" style="gap:12px; display: flex; flex-wrap: wrap;">
      <div class="card" style="flex: 1; min-width: 400px;">
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
          <span class="pill pill-4" id="stat4">ç©ºã4: --ä»¶</span>
          <span class="pill pill-3" id="stat3">ç©ºã3: --ä»¶</span>
          <span class="pill pill-2" id="stat2">ç©ºã2: --ä»¶</span>
          <span class="pill pill-1" id="stat1">ç©ºã1: --ä»¶</span>
          <span class="pill pill-0" id="stat0">ç©ºã0: --ä»¶</span>
        </div>
        <div id="board"></div>
      </div>

      <div class="card" style="flex: 1; min-width: 300px;">
        <h2 style="margin:0 0 8px;font-size:18px;">æŠ•ç¨¿è€…åˆ¥ å–å¾—ãƒªã‚¹ãƒˆ</h2>
        <div id="userAlloc" class="user-list"></div>
      </div>
    </section>

    <section class="row" style="margin-top:12px; display: grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px;">æŠ•ç¨¿ãƒ­ã‚°</h2>
        <div class="logs" id="logs"></div>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px;">ä½¿ã„æ–¹ãƒ¡ãƒ¢</h2>
        <ul style="font-size:14px; color:#374151;">
          <li>åŸºåœ°å–å¾—ï¼š<code>5,12,27</code></li>
          <li>ç©ºãè¿½åŠ ï¼š<code>-5,12</code>ï¼ˆå…ˆé ­ã«ãƒã‚¤ãƒŠã‚¹ï¼‰</li>
          <li>ãŠä¼‘ã¿ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ï¼šONã®é–“ã€åå‰ãƒœã‚¿ãƒ³ä¸€æ‹¬è¿½åŠ ã‚„ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ãŒå¯èƒ½ã€‚</li>
        </ul>
      </div>
    </section>
  </div>

  <script>
  (function(){
    const BOARD_SIZE=55, MAX_SLOTS=4, TILE=34;
    const MAINT_GROUPS = {
      "Ford": [1,2,3,4,5,6,7,20,21,22,23,24,27,28,38,39,40,41,42,45,46],
      "saku": [13,14,15,16,17,18,19,31,32,33,34,35,36,37,49,50,51,52,53,54,55],
      "Astro": [13,14,15,16,17,18,30,33,34,35,36,37,48,51,52,53,54,55],
      "sus": [8,9,10,11,12,25,26,27,28,29,43,44,45,46,47],
      "sam": [8,9,10,11,12,19,30,33,34,35,36,37,48,51,52,53,54,55],
      "ysnr": [13,15,17,19,29,30,31,32,47,48,49,50],
      "niya": [13,14,15,16,17,18,29,30,31,32,36,37,47,48,49,50,51,52],
      "lune": [8,9,10,11,12,20,21,22,25,26,40,41,42,43,44],
      "snow": [4,10,11,12,28,29,31,32,46,47,49,50],
      "å¤§å¸": [5,18,19,33,34,35,53,54,55],
      "ã¾ãƒ¼": [1,2,3,25,26,27,43,44,45],
      "keito": [4,5,23,24,38,39],
      "gato": [6,7,23,24,38,39],
      "ç¥é¾": [6,7,20,21,22,40,41,42],
      "hina": [1,2,3]
    };

    let state = { remaining: [], owners: {}, logs: [], lastUpdate: 0, status: "" };

    const elBoard=document.getElementById('board');
    const elLogs=document.getElementById('logs');
    const elReply=document.getElementById('reply');
    const elLast=document.getElementById('lastUpdate');
    const inUser=document.getElementById('inUser');
    const inNums=document.getElementById('inNums');
    const btnPost=document.getElementById('btnPost');
    const btnReset=document.getElementById('btnReset');
    const btnMaint=document.getElementById('btnMaint');
    const elMaintBar=document.getElementById('maintBar');
    const elUserAlloc=document.getElementById('userAlloc');
    const elStat = { 0: document.getElementById('stat0'), 1: document.getElementById('stat1'), 2: document.getElementById('stat2'), 3: document.getElementById('stat3'), 4: document.getElementById('stat4') };

    const LAYOUT=[ [0,42,0.5,0,0,0.5,0,0,0.5,0,55],[40,41,0.5,45,46,0.5,49,50,0.5,53,54],[38,39,0.5,43,44,0.5,47,48,0.5,51,52],[0,0,0.5,0,0,0.5,0,0,0.5,0,0],[23,24,0.5,27,28,0.5,31,32,0.5,36,37],[21,22,0.5,25,26,0.5,29,30,0.5,34,35],[0,20,0.5,0,0,0.5,0,0,0.5,0,33],[0,0,0.5,0,0,0.5,0,0,0.5,0,0],[0,7,0.5,0,0,0.5,19,0,0.5,0,0],[5,6,0.5,12,0,0.5,17,18,0.5,0,0],[3,4,0.5,10,11,0.5,15,16,0.5,0,0],[1,2,0.5,8,9,0.5,13,14,0.5,0,0] ];

    elBoard.style.display='grid';
    elBoard.style.gridTemplateColumns = LAYOUT[0].map(v => (v === 0.5 ? TILE * 0.5 : TILE) + 'px').join(' ');

    const cells=[];
    for(const row of LAYOUT){
      for(const n of row){
        const d=document.createElement('div');
        if(n === 0.5 || n === 0){
          d.style.width = (n === 0.5 ? TILE * 0.5 : TILE) + 'px';
          d.style.height = TILE + 'px';
          d.style.visibility = 'hidden';
          elBoard.appendChild(d);
          continue;
        }
        d.className='cell bg-4';
        d.style.width = TILE + 'px';
        d.style.height = TILE + 'px';
        const inner=document.createElement('div');
        inner.className='cell-inner';
        const num=document.createElement('div');
        num.className='num'; num.textContent=String(n);
        const sub=document.createElement('div');
        sub.className='sub'; sub.textContent='ç©ºã4';
        inner.appendChild(num); inner.appendChild(sub);
        d.appendChild(inner);
        elBoard.appendChild(d);
        cells[n]={root:d,sub};
      }
    }

    function renderBoard(){
      for(let n=1;n<=BOARD_SIZE;n++){
        const c=cells[n]; if(!c) continue;
        const rem = state.remaining[n];
        c.root.className = 'cell bg-' + rem;
        c.sub.textContent = 'ç©ºã' + rem;
      }
    }

    function renderStats(){
      const cnt={0:0,1:0,2:0,3:0,4:0};
      for(let i=1;i<=BOARD_SIZE;i++) cnt[state.remaining[i]]++;
      for(let i=0;i<=4;i++) elStat[i].textContent=`ç©ºã${i}: ${cnt[i]}ä»¶`;
    }

    function renderLogs(){
      elLogs.innerHTML = (state.logs||[]).map(l => `
        <div class="log-item">
          <div class="muted">${new Date(l.at).toLocaleTimeString()} ãƒ» ${l.user}</div>
          <div>${l.results.map(r => `<span class="badge ${r.ok?'badge-ok':'badge-ng'}">${r.number||''} ${r.type==='inc'?'+1':r.ok?'å–å¾—':'å¤±æ•—'}</span>`).join('')}</div>
        </div>`).join('') || '<div class="muted">æŠ•ç¨¿ãªã—</div>';
    }

    function renderMeta(){ elLast.textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date(state.lastUpdate).toLocaleTimeString(); }

    function renderStatus() {
      document.getElementById("statusText").textContent = state.status || "åŸºåœ°ç²å¾—æŠ•ç¨¿å¾…ã¡";
    }

    function renderUserAlloc(){
      const map=new Map();
      for(let n=1;n<=BOARD_SIZE;n++){
        (state.owners[n] || []).forEach(u=>{
          if(!map.has(u)) map.set(u,[]);
          map.get(u).push(n);
        });
      }
      elUserAlloc.innerHTML = Array.from(map.entries()).map(([u, ns]) => `
        <div class="user-item">
          <div class="user-name">${u}ï¼ˆ${ns.length}ä»¶ï¼‰</div>
          <div class="nums">${ns.sort((a,b)=>a-b).map(n=>`<span class="n ${u.includes('ãŠä¼‘ã¿')?'n-rest':''}">${n}</span>`).join('')}</div>
        </div>`).join('') || '<div class="muted">ç¢ºä¿ãªã—</div>';
    }

    function renderAll(){
      renderBoard(); renderStats(); renderLogs(); renderMeta(); renderUserAlloc(); renderStatus(); // â˜… è¿½åŠ 
    }

    async function fetchStateFromServer(){
      try{
        const res = await fetch('/state');
        state = await res.json();
        renderAll();
      }catch(e){ console.error(e); }
    }

    // â˜… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´é–¢æ•°
    window.setStatus = async function(s) {
      await fetch('/setStatus', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: s })
      });
      fetchStateFromServer();
    };

    async function post(){
      const val = inNums.value.trim();
      const mode = val.startsWith('-') ? 'inc' : 'take';
      const nums = (mode==='inc' ? val.slice(1) : val).split(',').map(Number).filter(n=>n>=1&&n<=55);
      if(!nums.length) return;
      const res = await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode, numbers: nums, user: inUser.value || 'åŒ¿å' })
      });
      state = await res.json();
      renderAll();
      inNums.value='';
    }

    async function resetAll(){
      if(!confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      await fetch('/reset', {method:'POST'});
      fetchStateFromServer();
    }

    let maint=false;
    function setMaint(on){
      maint = on;
      document.body.classList.toggle('maint-on', maint);
      elMaintBar.style.display = maint ? 'flex' : 'none';
      const wrap = document.getElementById('maintButtons');
      wrap.innerHTML = maint ? Object.keys(MAINT_GROUPS).map(name => `<button class="btn" onclick="maintGroupInc('${name}')">${name}</button>`).join('') : '';
    }

    window.maintGroupInc = async function(name){
      await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode: 'inc', numbers: MAINT_GROUPS[name], user: name + 'ã•ã‚“ãŠä¼‘ã¿' })
      });
      fetchStateFromServer();
    };

    async function handleCellClick(n){
      if(!maint) return;
      const mode = state.remaining[n] === MAX_SLOTS ? 'set0' : 'inc';
      await fetch('/post', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode, numbers: [n], user: 'SYSTEM' })
      });
      fetchStateFromServer();
    }

    btnPost.onclick = post;
    btnReset.onclick = resetAll;
    btnMaint.onclick = () => setMaint(!maint);
    for(let n=1; n<=BOARD_SIZE; n++) if(cells[n]) cells[n].root.onclick = () => handleCellClick(n);

    fetchStateFromServer();
    setInterval(fetchStateFromServer, 2000);
    setInterval(() => {
      document.getElementById('nowTime').textContent = 'ç¾åœ¨æ™‚åˆ»: ' + new Date().toLocaleTimeString();
    }, 1000);
  })();
  </script>
</body>
</html>